---
title: "Advanced roles"
author: "BeDataDriven B.V."
date: "`r Sys.Date()`"
layout: docArticle
category: tutorials
order: 0
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
relatedVideos:
- /support/webinars/2023-10-19-office-hour-designing-roles
- /support/webinars/2023-10-12-best-practices-for-designing-roles
vignette: >
  %\VignetteIndexEntry{Advanced user and role management}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(activityinfo)
```

## Introduction
If you are new to grant-based roles, start with "[Working with grant-based roles](working-with-grant-based-roles.html)", which also covers role parameters for row level access and auditing roles across multiple databases.

This tutorial will provide advanced use cases for how to create and work with grant-based roles and permissions. Included are:
- row-level access using multiple parameters in a role

Note: in order to fully follow this tutorial you must have an ActivityInfo user account or a trial account with the permission to add a new database. Setup a free trial here: https://www.activityinfo.org/signUp

## Row-level access using multiple parameters in a role

In order to efficiently manage row-level access across a database it is important to add codes to reference fields that are used to determine access. If a user is assigned a "Funder" role with a parameter "Funding partner" so that we know to which partner organization the person belongs, then it is best that each table that is restricted by funding partner has a field with the same code. In this case, the field code could be `fundingpartner`.

### EXAMPLE 1: Create a role based on two different parameters. 

**Description:** In this example we want the role to be based on field office and the partner. 

This requires two different parameters that will depend on two different reference tables and the coded reference fields:

1. The field office reference form with field code `field_office`
2. The partner reference form with field code `reporting_partner`

For example, the reporting form "Reports" will need to have a reference field `field_office` that points to the field office and a reference field `reporting_partner` so that the user may access the table records. If either field is missing, the user will not have access.

```{r eval=FALSE, include=TRUE}
databaseId <- "<database id>"
reportingFormId <- "<reporting form id>"

# the user will need view access to these forms to be able to select 
fieldOfficeReferenceFormId <- "<field office form id>"
reportingPartnerReferenceFormId <- "<reporting partner form id>"

# setup parameters pointing to the reference forms
partnerParameter <- parameter(
  id = "reporting_partner", 
  label = "Reporting Partner", 
  range = reportingPartnerReferenceFormId
)
fieldOfficeParameter <- parameter(
  id = "field_office", 
  label = "Field Office", 
  range = fieldOfficeReferenceFormId
)

# write the condition we will use on different operations
combinedConditions <- "field_office == @user.field_office&&reporting_partner == @user.partner"

# the user should be able to view the list of partners and field offices to be able to select their own in reports
referenceFormPermissions <- resourcePermissions(
  view = TRUE,
  discover = FALSE,
  edit_record = FALSE)

partnersFormGrant <- grant(
  resourceId = reportingPartnerReferenceFormId, 
  permissions = referenceFormPermissions
)

fieldOfficeFormGrant <- grant(
  resourceId = fieldOfficeReferenceFormId, 
  permissions = referenceFormPermissions
)

# record level access: view, add and edit only records where the partner and field office match @user
reportingFormGrant <- grant(resourceId = reportingForm$id,
               permissions = resourcePermissions(
                 view = combinedConditions,
                 edit_record = combinedConditions,
                 add_record = combinedConditions,
                 discover = TRUE,
                 export_records = TRUE))


# grant access to just one table
exampleRole1 <- role(  
  id = "rp",
  label = "Reporting Partner",
  grants = list(
    partnersFormGrant,
    fieldOfficeFormGrant,
    reportingFormGrant
  ),
  parameters = list(
    partnerParameter,
    fieldOfficeParameter
  )
)

# grant access to any table that has both a reporting partner and field office field
globalGrant <- grant(resourceId = databaseId,
               permissions = resourcePermissions(
                 view = combinedConditions,
                 edit_record = combinedConditions,
                 add_record = combinedConditions,
                 discover = TRUE,
                 export_records = TRUE))

# replace the partners form grant with the database grant `globalGrant`
exampleRole1 <- role(  
  id = "rp_global",
  label = "Reporting Partner (global access to reporting tables)",
  grants = list(
    globalGrant,
    fieldOfficeFormGrant,
    reportingFormGrant
  ),
  parameters = list(
    partnerParameter,
    fieldOfficeParameter
  )
)

updateRole(databaseId, exampleRole1)

## IMPORTANT NOTE: both parameters should be TRUE at the same time, thus the "&&" symbol is used

```

### EXAMPLE 2: Create a role with access only to the records that the user added. 

**Description:** Counselors can only access their own records in a database. The forms of interest must include a user field to keep track of the user. We can create this role by making sure that any form that they can access contains a user field code named "pwname". It is required to define a field code when granting conditional access across the whole database.

In our example the user field has the field code named "pwname". 

```{r eval=FALSE, include=TRUE}
databaseId <- "<database id>"

exampleRole2 <- role(
  id = "counselor",
  label = "Counselor",
  grants = 
    list(
      grant(
        resourceId = databaseId, 
        permissions = resourcePermissions(
          view="@user==pwname",
          add_record=TRUE,
          edit_record= "@user==pwname"
        )
      )
  )
)

updateRole(databaseId, exampleRole2)

```

### EXAMPLE 3: We want to create a role based on one parameter

**Description:** In this example, we want a role so that each person from a specific reporting country will have access only to the respective records under the country. 

```{r eval=FALSE, include=TRUE}
DatabaseId <- "<database id>"

role <- list(
  id = "countryreporting",
  label = "Member Country Reporting",
  permissions = list(),
  parameters = list(
    list(parameterId = "country",
         label = "Country",
         range = "referencetableid which includes the country information")
  ),
  filters = list(
    list(id = "country",
         label = "country is user's country",
         filter = "referencetableid == @user.country")
  )
)

updateRole(databaseId, role)
```

### EXAMPLE 4: Access based on three parameters

**Description:** In this example we want to create a role so that a user may have access to one, two or three field offices

```{r eval=FALSE, include=TRUE}
DatabaseId <- "<database id>"

role1 <- list(
  id = "administrator",
  label = "Administrator",
  permissions = list(),
  parameters = list(
    list(parameterId = "field_office_1",
         label = "Field office 1",
         range = "referencetableid which includes the field office information"),
    list(parameterId = "field_office_2",
         label = "Field office 2",
         range = "referencetableid which includes the field office information"),
    list(parameterId = "field_office_3",
         label = "Field office 3",
         range = "referencetableid which includes the field office information")
  ),
  filters = list(
    list(id = "field_office",
         label = "field office is user's field office",
         filter = "referencetableid== @user.field_office_1||
                   referencetableid == @user.field_office_2||
                   referencetableid == @user.field_office_3")
  )
)

updateRole(databaseId, role1)

## IMPORTANT NOTE:  the "||" symbols stands for OR in R
```
