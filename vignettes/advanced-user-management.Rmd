---
title: "Advanced user management"
author: "BeDataDriven B.V."
date: "`r Sys.Date()`"
layout: docArticle
category: tutorials
order: 0
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
relatedVideos:
- /support/webinars/2023-10-19-office-hour-designing-roles
- /support/webinars/2023-10-12-best-practices-for-designing-roles
vignette: >
  %\VignetteIndexEntry{Advanced user management}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(activityinfo)
library(readr)
library(readxl)

```

## Introduction

If you are new to grant-based roles, start with "[Working with grant-based roles](working-with-grant-based-roles.html)", which also covers role parameters for row level access and auditing roles across multiple databases.

This tutorial will cover advanced use cases where database administrators may be required to apply bulk operations on a number of users at the same time.

This includes adding and updating users:

-   bulk inviting users and assigning roles, using optional resources and role parameters
-   bulk updating role assignments while retaining important user parameters

It also includes removing access to the database in different ways:

-   deactivate users to retain their metadata for auditing purposes
-   bulk delete multiple users from a database to delete users and remove their metadata

Note: in order to fully follow this tutorial you must have an ActivityInfo user account or a trial account with the permission to add a new database. Setup a free trial here: <https://www.activityinfo.org/signUp>

## Providing access to the database

### Bulk inviting multiple users and assigning roles

#### EXAMPLE 1: Add multiple new users in your database.

In this example we have saved the users' names and emails in a csv file named `Users.csv` with columns `name` and `email`. We will import this csv file in R and then loop through each row to add the database user.

```{r eval=FALSE, include=TRUE}
databaseId <- "<the database id>"
users <- readr::read_csv("Users.csv")
roleId = "readonly"

# R runs through all the rows of the csv and creates users based on "email" and "name" columns

for (i in seq_len(nrow(users))) {
    tryCatch(
      expr = {
        addDatabaseUser(databaseId,
                  users[i,"email"],
                  users[i,"name"],
                  roleId=roleId)
      },
      error = function(e) {
        warning(sprintf("Failed to add user %s with error: %s.", users[i,"email"], e))
      }
    )
}

```

#### EXAMPLE 2: Add multiple users and assign optional grants and parameters

In this example, we’ll add users to the system while assigning optional grants for specific resources and defining row-level access controls using parameters. This builds upon the example from "[Record-level access using parameters](working-with-grant-based-roles.html#record-level-access-control-using-parameters)" to allow precise user permissions.

To structure our CSV file, we’ll use column names that clearly distinguish between parameters and grants:

Parameter columns will start with the prefix "p:", followed by the parameter name. Grant columns will start with the prefix "g:", followed by the form label.

This approach allows us to quickly identify columns related to either parameters or optional grants in the CSV file, which will include the following columns:

-   `name`: the user's name
-   `email`: the user’s email address
-   `role`: the user’s role ID
-   `Partner name`: the user's organization name, which we’ll use to look up the corresponding ID in the reporting partner table
-   `g:Reporting Partners`: An optional grant to the Reporting Partners form. 1 grants write access and 0 grants read-only access
-   `p:Partner` (optional): the user’s reporting partner ID. It will be filled in by our script based on the `Partner name.`

This example builds on "[Assigning users a reporting partner role](working-with-grant-based-roles.html#assigning-users-a-reporting-partner-role)" by enabling optional editing rights to the `Reporting Partner` form using an optional grant.

The first step in our process is to retrieve the partner id of each user based on partner names in the column `Partner name`. The following script performs this look up and raises an error if any names do not match.

```{r eval=FALSE, include=TRUE}
databaseId <- "you add the database ID under the URL"
reportingPartnerReferenceFormId = "the id of the reporting partner form"

users <- readr::read_csv("Users.csv")

# Get the names and ids of partners for the look up
partners <- getRecords(reportingPartnerReferenceFormId) %>% collect()

# Identify and report any reporting partner names that do not match our partner form data
wrongPartnerNames <- users[["Partner name"]][ !users[["Partner name"]] %in% partners[["Partner name"]] ]

if (length(wrongPartnerNames) > 0) {
  stop("Error: The following values in `Partner name` do not have a corresponding _id in the Reporting Partners form: ", paste(unmatched, collapse = ", "), ". Please fix the names and start over.")
}

# Map partner names to partner ids
partnerIdMap <- setNames(
  partners[["_id"]],
  partners[["Partner name"]]
)

# Add missing ids to the `p:Partners` column
users <- users |>
  mutate(
    `p:Partner` = coalesce(`p:Partner`, partnerIdMap[`Partner name`])
    )

```

Now we have the partner id for each user.

The second step is to retrieve all the role grants and parameters corresponding to each column in the CSV file. We will use this information to correctly add the user roles.

```{r eval=FALSE, include=TRUE}
# get database role definitions and resources
dbTree <- getDatabaseTree(databaseId)
dbResources <- getDatabaseResources(databaseId)
roles <- getDatabaseRoles(dbTree)

columnNames <- names(users)

# treat grant and parameter columns differently
grantColumns <- columnNames[grep("^g:", columnNames)]
parameterColumns <- columnNames[grep("^p:", columnNames)]

# identify optional grants for the `g:` prepended columns
optionalGrants <-
  roles |>
  select(roleId = id, roleLabel = label, grants) |> 
  tidyr::unnest_longer(grants) |> 
  tidyr::unnest_wider(grants) |> 
  filter(optional == TRUE) |> 
  left_join(dbResources, by = c(resourceId = "id")) |> 
  filter(!is.na(label))

grantColumnDfs <- lapply(substring(grantColumns, 3), function(x) {
  df = optionalGrants |> filter(label == x)
  if (nrow(df) != 1) {
    stop(sprintf("Error: %s matches. There is no unique corresponding grant for column '%s' in the CSV file.", nrow(df), x))
  }
  df
})
names(grantColumnDfs) <- grantColumns

# identify role parameters for each `p:` prepended columns
roleParameters <- 
  roles |> 
  select(roleId = id, roleLabel = label, parameters)  |> 
  tidyr::unnest_longer(parameters) |> 
  tidyr::unnest_wider(parameters)

# make a list of roles that contain a corresponding parameter label
parameterColumnDfs <- lapply(substring(parameterColumns, 3), function(x) {
  df = roleParameters |> filter(label == x )
  if (nrow(df) == 0) {
    stop(sprintf("Error: No corresponding parameter for column '%s' in the CSV file.", x))
  }
  df
})
names(parameterColumnDfs) <- parameterColumns


```

If we use the same database created in the basic tutorial, we see the following:

```{r eval=FALSE, include=TRUE}

# optional grants
grantColumnDfs

```


```
$`g:Reporting Partners`
# A tibble: 1 × 9
  roleId roleLabel         resourceId                   optional operations label              type  parentId         visibility
  <chr>  <chr>             <chr>                        <lgl>    <list>     <chr>              <chr> <chr>            <chr>     
1 rp     Reporting Partner <reporting_partner_form_id>  TRUE     <list [3]> Reporting Partners FORM  <parent_id>      PRIVATE   
```

We now know the form id from the `resourceId` column and we will be able to set the optional grant

```{r eval=FALSE, include=TRUE}

# optional grants
parameterColumnDfs

```


```
$`p:Partner`
# A tibble: 1 × 5
  roleId roleLabel         parameterId label   range           
  <chr>  <chr>             <chr>       <chr>   <chr>           
1 rp     Reporting Partner partner     Partner <reporting_partner_form_id>

```

We now know the parameter id from the `parameterId` column for the parameter we will add to the role.

Finally, we can loop through each new user record and apply the role, optional grants, and parameters.

```{r eval=FALSE, include=TRUE}

# creates a named list item for each parameter where the name is the parameterId and the value is the parameter value.
createParameterItem <- function(parameterId, value) {
  item <- list(value)
  names(item) <- parameterId
  item
}

for (i in seq_len(nrow(users))) {
    tryCatch(
      expr = {
        email = users[[i,"email"]]
        role = users[[i,"role"]]
        name = users[[i,"name"]]
        
        roleParameters = list()
        for (paramCol in parameterColumns) {
          # get the parameters corresponding to the role
          df <- parameterColumnDfs[[paramCol]] %>% filter(roleId == role)
          if (nrow(df)==1) {
            
            # Create the parameter item
            parameterItem <- createParameterItem(
                parameterId = df[[1,"parameterId"]], 
                value = reference(reportingPartnerReferenceFormId, users[[i,paramCol]])
              )
            
            # Add item to roleParameters
            roleParameters <- 
              c(
                roleParameters, 
                parameterItem
              )
          }
        }
        
        roleResources = list()
        for (grantCol in grantColumns) {
          # Get the table with the resourceId corresponding to the grant
          df <- grantColumnDfs[[grantCol]] %>% filter(roleId == role)
          
          # Add the optional resources if the grant column equals 1
          if (nrow(df)==1&&users[[i,grantCol]]==1) {
            roleResources <- c(roleResources, df[[1,"resourceId"]])
          }
        }

        # Add a database user using the assignment parameter which matches the assignment of roles in updateUserRole()
        addDatabaseUser(databaseId,
                  email,
                  name,
                  assignment = roleAssignment(
                    roleId = role,
                    roleParameters = roleParameters,
                    roleResources = roleResources
                  )
        )
      },
      error = function(e) {
        warning(sprintf("Failed to add user %s with error: %s.", users[[i,"email"]], e))
      }
    )
}

```

We will use the parameters may be defined through a "Name" column in a reference table and we will allow users to add the record "Name" instead of the record id in the reference table.

First we will list the optional grants and get the grant resource label.

## Removing access to the database

### Examples of how to delete multiple users from a database

For this set of examples we will use the `deleteDatabaseUser function`:

#### EXAMPLE 1: delete multiple users using the users export under the user management in ActivityInfo.

```{r eval=FALSE, include=TRUE}
databaseId <- "<database ID>"


# you export from the user management the users list and you keep the users that you want to delete and save it as "userstodelete.xlsx" and put it in your working directory
usersToDelete <- readxl::read_excel("userstodelete.xlsx")
  
# R runs through all the rows and deletes based on the "UserId" column

for (i in seq_len(nrow(usersToDelete))) {
    tryCatch(
      expr = {
        deleteDatabaseUser(databaseId, usersToDelete[i,"UserId"])
      },
      error = function(e) {
        warning(sprintf("Failed to delete user %s with error: %s.", usersToDelete[i,"Email"], e))
      }
    )
}

```

#### EXAMPLE 2: delete users based on user emails that you wish to delete.

```{r eval=FALSE, include=TRUE}
databaseId <- "<database ID>"

emailsToDelete <- c("email.1@gmail.com", 
                    "email.@gmail.com" 
)

dbUsers <- getDatabaseUsers(databaseId, asDataFrame = FALSE)

for(user in dbUsers) {
  if((tolower(user$email) %in% tolower(emailsToDelete))) {
    cat(sprintf("Deleting %s...\n", user$email))
    tryCatch(
      expr = {
        deleteDatabaseUser(databaseId, user$userId)
      },
      error = function(e) {
        warning(sprintf("Failed to delete user %s with error: %s.", user$email, e))
      }
    )
  }
}
```

#### EXAMPLE 3: delete users based on user emails that you wish to keep.

```{r eval=FALSE, include=TRUE}
databaseId <- "<database ID>"
emailsToKeep <- c("email1@gmail.com")

dbUsers <- getDatabaseUsers(databaseId, asDataFrame = FALSE)

for(user in dbUsers) {
  if(!(tolower(user$email) %in% emailsToKeep)) {
    cat(sprintf("Deleting %s...\n", user$email))
    tryCatch(
      expr = {
        deleteDatabaseUser(databaseId, user$userId)
      },
      error = function(e) {
        warning(sprintf("Failed to delete user %s with error: %s.", user$email, e))
      })
  }
}

```
